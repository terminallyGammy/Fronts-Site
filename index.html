<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Current Fronters</title>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: #fdfdfd;
      color: #333;
      max-width: 640px;
      margin: 2rem auto;
      padding: 1rem;
      text-align: center;
    }
    h1 { letter-spacing: 0.5px; }
    .front {
      margin: 0.5rem auto;
      padding: 0.6rem 0.8rem;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fafafa;
      width: 80%;
    }
    .note { font-size: 0.9rem; opacity: 0.8; margin-top: 0.75rem; }
  </style>
</head>
<body>
  <h1>⋆˚✿˖°Current Fronters⋆˚✿˖°</h1>
  <div id="fronts">Loading...</div>
  <div class="note" id="meta"></div>

  <script>
    function fmtDate(x) {
      if (!x) return "";
      // Accept ISO strings or numbers (ms or s)
      const n = Number(x);
      const d = Number.isFinite(n)
        ? new Date(n > 1e12 ? n : n * 1000)   // treat < 1e12 as seconds
        : new Date(String(x));
      return isNaN(+d) ? "" : d.toLocaleString();
    }

    async function loadFronts() {
      const out = document.getElementById("fronts");
      const meta = document.getElementById("meta");

      try {
        const res = await fetch("./fronts.json", { cache: "no-store" });
        const raw = await res.text();
        if (!res.ok) {
          out.textContent = "Error loading fronts.";
          console.error("HTTP", res.status, res.statusText, raw.slice(0, 200));
          return;
        }

        let data;
        try { data = JSON.parse(raw); }
        catch { out.textContent = "Error loading fronts."; console.error("Invalid JSON:", raw.slice(0,200)); return; }

        // Normal case: { membersFronting: [...] , lastChange: ... }
        if (data && !Array.isArray(data) && Array.isArray(data.membersFronting)) {
          const arr = data.membersFronting;
          if (arr.length === 0) {
            out.textContent = "No one fronting right now.";
          } else {
            out.innerHTML = arr.map(m => `
              <div class="front" style="border-left: 8px solid ${m.color || "#ddd"};">
                ${m.displayName || m.name || m.id || "Unnamed"}
              </div>
            `).join("");
          }
          meta.textContent = data.lastChange ? ("Last change: " + fmtDate(data.lastChange)) : "";
          return;
        }

        // Fallback: if the workflow ever outputs history array (shouldn't now), show live IDs
        if (Array.isArray(data)) {
          const live = data.filter(x => x?.content?.live);
          if (live.length === 0) {
            out.textContent = "No one fronting right now.";
            meta.textContent = "";
            return;
          }
          out.innerHTML = live.map(x => `
            <div class="front">${x.content.member}</div>
          `).join("");
          meta.textContent = "";
          return;
        }

        out.textContent = "Error loading fronts.";
        console.error("Unexpected JSON shape:", data);

      } catch (err) {
        out.textContent = "Error loading fronts.";
        console.error(err);
      }
    }
    loadFronts();
  </script>
</body>
</html>
