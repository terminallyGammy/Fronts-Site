<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Current Fronters</title>
  <style>
    :root {
      --card-w: 680px;
    }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: #fdfdfd;
      color: #333;
      max-width: var(--card-w);
      margin: 2rem auto;
      padding: 1rem;
      text-align: center;
    }
    h1 { letter-spacing: 0.5px; margin-bottom: 1rem; }
    .front {
      margin: 0.5rem auto;
      padding: 0.9rem 1rem;
      border: 1px solid #ddd;
      border-radius: 12px;
      background: #fafafa;
      text-align: left;
      display: grid;
      grid-template-columns: 56px 1fr;
      grid-gap: 12px;
      align-items: center;
      width: 100%;
      box-sizing: border-box;
    }
    .avatar {
      width: 56px; height: 56px; border-radius: 50%;
      background: #eee; object-fit: cover; border: 1px solid #ddd;
    }
    .title { font-weight: 600; }
    .subtle { opacity: 0.8; font-size: 0.95rem; }
    .warning {
      grid-column: 1 / -1;
      margin-top: 6px;
      padding: 10px 12px;
      border-radius: 10px;
      background: #fff6f6;
      border: 1px solid #f3c2c2;
      color: #8b2c2c;
      font-size: 0.95rem;
      white-space: pre-wrap;
    }
    .note { font-size: 0.9rem; opacity: 0.8; margin-top: 0.75rem; }
  </style>
</head>
<body>
  <h1>⋆˚✿˖°Current Fronters⋆˚✿˖°</h1>
  <div id="fronts">Loading...</div>
  <div class="note" id="meta"></div>

  <script>
    function fmtDate(x) {
      if (!x) return "";
      const n = Number(x);
      const d = Number.isFinite(n) ? new Date(n > 1e12 ? n : n * 1000) : new Date(String(x));
      return isNaN(+d) ? "" : d.toLocaleString();
    }
    function esc(s){ return String(s ?? "").replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    async function loadFronts() {
      const out = document.getElementById("fronts");
      const meta = document.getElementById("meta");

      try {
        const res = await fetch("./fronts.json", { cache: "no-store" });
        const raw = await res.text();
        if (!res.ok) { out.textContent = "Error loading fronts."; console.error(res.status, raw); return; }

        let data; try { data = JSON.parse(raw); } catch { out.textContent="Error loading fronts."; console.error("Invalid JSON", raw); return; }

        if (!data || Array.isArray(data) || !Array.isArray(data.membersFronting)) {
          out.textContent = "No one fronting right now."; meta.textContent = ""; return;
        }
        const arr = data.membersFronting;

        if (arr.length === 0) {
          out.textContent = "No one fronting right now.";
        } else {
          out.innerHTML = arr.map(m => {
            const name = m.displayName || m.name || m.id || "Unnamed";
            const pronouns = m.pronouns ? ` (${esc(m.pronouns)})` : "";
            const color = m.color || "#ddd";
            const avatar = m.avatar || ""; // may be empty if privacy blocks images
            const warning = m.warning || "";

            return `
              <div class="front" style="border-left: 8px solid ${color};">
                ${avatar ? `<img class="avatar" src="${esc(avatar)}" alt="" loading="lazy" />`
                         : `<div class="avatar"></div>`}
                <div>
                  <div class="title">${esc(name)}${pronouns}</div>
                </div>
                ${warning ? `<div class="warning">${esc(warning)}</div>` : ""}
              </div>
            `;
          }).join("");
        }

        meta.textContent = data.lastChange ? ("Last change: " + fmtDate(data.lastChange)) : "";
      } catch (err) {
        out.textContent = "Error loading fronts.";
        console.error(err);
      }
    }
    loadFronts();
  </script>
</body>
</html>
