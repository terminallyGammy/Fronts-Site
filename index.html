<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Current Fronters</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --card-bg: #fff;
      --border: #e5e7eb;
      --text: #111827;
      --muted: #6b7280;
      --pill: #f3f4f6;
      --warn-bg: #fff7ed;
      --warn-border: #f59e0b;
    }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: #f9fafb;
      color: var(--text);
      max-width: 780px;
      margin: 2rem auto;
      padding: 1rem;
    }
    h1 { text-align: center; margin: 0 0 1rem; font-weight: 800; }
    #meta { text-align: center; color: var(--muted); font-size: .95rem; margin-bottom: 1.25rem; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; }
    .front {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 1rem;
      display: grid;
      grid-template-columns: 64px 1fr;
      grid-template-rows: auto auto auto;
      gap: .5rem 1rem;
      align-items: start;
    }
    .bar { height: 6px; background: var(--pill); border-radius: 999px; grid-column: 1 / -1; }
    .avatar {
      width: 64px; height: 64px; border-radius: 12px; object-fit: cover; background: #eee; border: 1px solid var(--border);
      grid-row: 1 / span 2;
    }
    .name { font-size: 1.125rem; font-weight: 700; line-height: 1.2; }
    .pronouns { color: var(--muted); font-size: .95rem; }
    .desc, .warning, .fields { grid-column: 1 / -1; }
    .desc { font-size: .98rem; color: #1f2937; }
    .fields { display: flex; flex-direction: column; gap: .35rem; margin-top: .25rem; }
    .field { background: var(--pill); border: 1px solid var(--border); border-radius: 10px; padding: .45rem .6rem; font-size: .92rem; }
    .field b { color: #111827; }
    .warning {
      background: var(--warn-bg); border: 1px solid var(--warn-border);
      color: #92400e; border-radius: 10px; padding: .65rem .75rem; font-weight: 600; margin-top: .25rem;
    }
    .empty { text-align: center; color: var(--muted); font-size: 1.05rem; padding: 2rem 0; }
  </style>

  <!-- Markdown + sanitization -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js" defer></script>
</head>
<body>
  <h1>⋆˚✿˖° Current Fronters ⋆˚✿˖°</h1>
  <div id="meta">Loading…</div>
  <div id="fronts" class="grid"></div>

  <script>
    window.addEventListener('load', () => loadFronts());

    async function loadFronts() {
      const out = document.getElementById("fronts");
      const meta = document.getElementById("meta");
      try {
        const res = await fetch("./fronts.json", { cache: "no-store" });
        const raw = await res.text();
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${raw.slice(0,200)}`);
        const data = JSON.parse(raw || "{}");

        const lastChange = data?.lastChange ? new Date(data.lastChange) : null;
        meta.textContent = lastChange ? `Last change: ${lastChange.toLocaleString()}` : `Last change: —`;

        const list = Array.isArray(data?.membersFronting) ? data.membersFronting : [];
        if (list.length === 0) {
          out.innerHTML = `<div class="empty">No one is fronting right now.</div>`;
          return;
        }

        out.innerHTML = list.map(renderFront).join("");
      } catch (err) {
        console.error(err);
        meta.textContent = "Error loading fronts.json";
        out.innerHTML = `<div class="empty">Could not load current fronters.</div>`;
      }
    }

    function md(htmlish) {
      // Render Markdown safely
      try {
        const unsafe = marked.parse(String(htmlish ?? ""));
        return DOMPurify.sanitize(unsafe, {USE_PROFILES: {html: true}});
      } catch {
        return "";
      }
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function renderFront(m) {
      const color = m.color || "#e5e7eb";
      const name = m.displayName || m.name || "Unnamed";
      const pronouns = m.pronouns ? `<div class="pronouns">${escapeHtml(m.pronouns)}</div>` : "";
      const avatar = m.avatar
        ? `<img class="avatar" src="${escapeHtml(m.avatar)}" alt="" loading="lazy">`
        : `<div class="avatar" aria-hidden="true"></div>`;

      // Markdown for description & warning
      const desc = m.description ? `<div class="desc">${md(m.description)}</div>` : "";
      const warn = m.warning ? `<div class="warning">${md(m.warning)}</div>` : "";

      // Render custom fields (Markdown values)
      const fields = Array.isArray(m.fields) && m.fields.length
        ? `<div class="fields">${
            m.fields
              .filter(f => f?.label && f?.value)
              .map(f => `<div class="field"><b>${escapeHtml(f.label)}:</b> ${md(String(f.value))}</div>`)
              .join("")
          }</div>`
        : "";

      return `
        <div class="front">
          <div class="bar" style="background:${escapeHtml(color)}"></div>
          ${avatar}
          <div>
            <div class="name">${escapeHtml(name)}</div>
            ${pronouns}
          </div>
          ${desc}
          ${fields}
          ${warn}
        </div>
      `;
    }
  </script>
</body>
</html>
